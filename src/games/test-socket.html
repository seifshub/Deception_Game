<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deception Game Socket Test</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .events {
            height: 300px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .event-item {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
        }
        .event-received {
            background-color: #e3f2fd;
            border-left: 4px solid #2196F3;
        }
        .event-sent {
            background-color: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        button {
            padding: 8px 12px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        input, select {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .login-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        .game-phase {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2196F3;
        }
        .current-question {
            background-color: #fff9c4;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .answers-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .answer-option {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }
        .answer-option:hover {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="login-container">
        <h2>Login to Test Socket</h2>
        <div>
            <label for="username">Username:</label>
            <input type="text" id="username" placeholder="Username">
        </div>
        <div>
            <label for="password">Password:</label>
            <input type="password" id="password" placeholder="Password">
        </div>
        <button id="login-btn">Login</button>
        <div id="login-status"></div>
    </div>

    <!-- Game Testing Section (hidden until logged in) -->
    <div id="game-section" class="hidden">
        <h1>Deception Game Socket Test</h1>
        
        <div class="container">
            <div class="panel">
                <h2>Connection</h2>
                <div id="connection-status">Not Connected</div>
                <button id="connect-socket">Connect Socket</button>
                <button id="disconnect-socket">Disconnect</button>
            </div>
            
            <div class="panel">
                <h2>Game Actions</h2>
                <div>
                    <label for="game-id">Game ID:</label>
                    <input type="number" id="game-id" placeholder="Enter game ID">
                </div>
                <div>
                    <button id="join-game">Join Game Room</button>
                    <button id="leave-game">Leave Game Room</button>
                    <button id="start-game">Start Game</button>
                    <button id="end-game">End Game</button>
                </div>
            </div>
        </div>
        
        <div class="panel">
            <h2>Game State</h2>
            <div class="game-phase" id="game-phase">Not in a game</div>
            
            <!-- Topic Selection UI -->
            <div id="topic-selection" class="hidden">
                <h3>Choose a Topic</h3>
                <select id="topic-select"></select>
                <button id="submit-topic">Select Topic</button>
            </div>
            
            <!-- Answer Submission UI -->
            <div id="answer-submission" class="hidden">
                <h3>Submit Your Answer</h3>
                <div class="current-question" id="current-question"></div>
                <input type="text" id="answer-input" placeholder="Enter your fake answer">
                <button id="submit-answer">Submit Answer</button>
            </div>
            
            <!-- Voting UI -->
            <div id="voting" class="hidden">
                <h3>Vote for the Correct Answer</h3>
                <div class="current-question" id="voting-question"></div>
                <div class="answers-container" id="answers-container"></div>
                <button id="submit-vote">Submit Vote</button>
            </div>
            
            <!-- Results UI -->
            <div id="results" class="hidden">
                <h3>Round Results</h3>
                <div id="round-results"></div>
            </div>
            
            <!-- Final Results UI -->
            <div id="final-results" class="hidden">
                <h3>Final Results</h3>
                <div id="game-results"></div>
            </div>
        </div>
        
        <div class="panel">
            <h2>Event Log</h2>
            <div class="events" id="events-log"></div>
            <button id="clear-log">Clear Log</button>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let gameId;
        let currentRoundId;
        let selectedAnswerId;
        let answers = [];
        
        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const gameSection = document.getElementById('game-section');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const loginStatus = document.getElementById('login-status');
        const connectBtn = document.getElementById('connect-socket');
        const disconnectBtn = document.getElementById('disconnect-socket');
        const connectionStatus = document.getElementById('connection-status');
        const gameIdInput = document.getElementById('game-id');
        const joinGameBtn = document.getElementById('join-game');
        const leaveGameBtn = document.getElementById('leave-game');
        const startGameBtn = document.getElementById('start-game');
        const endGameBtn = document.getElementById('end-game');
        const eventsLog = document.getElementById('events-log');
        const clearLogBtn = document.getElementById('clear-log');
        const gamePhase = document.getElementById('game-phase');
        
        // Game UI sections
        const topicSelection = document.getElementById('topic-selection');
        const topicSelect = document.getElementById('topic-select');
        const submitTopicBtn = document.getElementById('submit-topic');
        const answerSubmission = document.getElementById('answer-submission');
        const currentQuestion = document.getElementById('current-question');
        const answerInput = document.getElementById('answer-input');
        const submitAnswerBtn = document.getElementById('submit-answer');
        const voting = document.getElementById('voting');
        const votingQuestion = document.getElementById('voting-question');
        const answersContainer = document.getElementById('answers-container');
        const submitVoteBtn = document.getElementById('submit-vote');
        const results = document.getElementById('results');
        const roundResults = document.getElementById('round-results');
        const finalResults = document.getElementById('final-results');
        const gameResults = document.getElementById('game-results');
        
        // Helper function to log events
        function logEvent(event, data, isSent = false) {
            const eventItem = document.createElement('div');
            eventItem.className = `event-item ${isSent ? 'event-sent' : 'event-received'}`;
            
            const timestamp = new Date().toLocaleTimeString();
            const direction = isSent ? '→ SENT' : '← RECEIVED';
            
            eventItem.innerHTML = `<strong>${timestamp} ${direction} ${event}</strong><br>
                                 <pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            eventsLog.appendChild(eventItem);
            eventsLog.scrollTop = eventsLog.scrollHeight;
        }
        
        // Login function
        loginBtn.addEventListener('click', async () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if (!username || !password) {
                loginStatus.textContent = 'Please enter both username and password';
                return;
            }
            
            try {
                const response = await fetch('http://localhost:3000/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    }),
                    credentials: 'include'
                });
                
                if (response.ok) {
                    loginStatus.textContent = 'Login successful!';
                    loginSection.classList.add('hidden');
                    gameSection.classList.remove('hidden');
                } else {
                    const errorData = await response.json();
                    loginStatus.textContent = `Login failed: ${errorData.message || 'Invalid credentials'}`;
                }
            } catch (error) {
                loginStatus.textContent = `Error: ${error.message}`;
            }
        });
        
        // Socket connection
        connectBtn.addEventListener('click', () => {
            try {
                // Connect to the socket.io server with the 'games' namespace
                socket = io('http://localhost:3000/games', {
                    withCredentials: true
                });
                
                connectionStatus.textContent = 'Connecting...';
                
                // Handle connection events
                socket.on('connect', () => {
                    connectionStatus.textContent = `Connected (ID: ${socket.id})`;
                    logEvent('connect', { socketId: socket.id });
                });
                
                socket.on('disconnect', () => {
                    connectionStatus.textContent = 'Disconnected';
                    logEvent('disconnect', {});
                });
                
                socket.on('connect_error', (error) => {
                    connectionStatus.textContent = `Connection Error: ${error.message}`;
                    logEvent('connect_error', { message: error.message });
                });
                
                // Handle game events
                socket.on('playerJoined', (data) => {
                    logEvent('playerJoined', data);
                });
                
                socket.on('playerLeft', (data) => {
                    logEvent('playerLeft', data);
                });
                
                socket.on('gameStarted', (data) => {
                    logEvent('gameStarted', data);
                    gamePhase.textContent = 'Game In Progress';
                });
                
                socket.on('gameMessage', (data) => {
                    logEvent('gameMessage', data);
                });
                
                socket.on('chooseTopic', (data) => {
                    logEvent('chooseTopic', data);
                    gamePhase.textContent = 'Choosing Topic';
                    
                    // Populate topic dropdown
                    topicSelect.innerHTML = '';
                    data.topics.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = topic.name;
                        topicSelect.appendChild(option);
                    });
                    
                    // Show topic selection UI
                    hideAllGameSections();
                    topicSelection.classList.remove('hidden');
                });
                
                socket.on('PlayerIsChoosingTopic', (data) => {
                    logEvent('PlayerIsChoosingTopic', data);
                    gamePhase.textContent = `${data.username} is choosing a topic...`;
                    hideAllGameSections();
                });
                
                socket.on('answerPrompt', (data) => {
                    logEvent('answerPrompt', data);
                    gamePhase.textContent = 'Submitting Answer';
                    currentRoundId = data.roundId;
                    
                    // Show the question
                    currentQuestion.textContent = data.prompt;
                    
                    // Show answer submission UI
                    hideAllGameSections();
                    answerSubmission.classList.remove('hidden');
                });
                
                socket.on('answerSubmitted', (data) => {
                    logEvent('answerSubmitted', data);
                });
                
                socket.on('answerCorrectChangeIt', (data) => {
                    logEvent('answerCorrectChangeIt', data);
                    alert(data.message);
                });
                
                socket.on('allAnswersSubmitted', (data) => {
                    logEvent('allAnswersSubmitted', data);
                    gamePhase.textContent = 'Voting Phase';
                    
                    // Store the answers for voting
                    answers = [...data.userAnswers, {
                        answerId: data.correctAnswerId,
                        content: data.correctAnswer
                    }];
                    
                    // Shuffle the answers for fairness
                    answers.sort(() => Math.random() - 0.5);
                    
                    // Show the question
                    votingQuestion.textContent = currentQuestion.textContent;
                    
                    // Populate answer options
                    answersContainer.innerHTML = '';
                    answers.forEach(answer => {
                        const answerDiv = document.createElement('div');
                        answerDiv.className = 'answer-option';
                        answerDiv.dataset.answerId = answer.answerId;
                        answerDiv.textContent = answer.content;
                        answerDiv.addEventListener('click', () => {
                            // Deselect all answers
                            document.querySelectorAll('.answer-option').forEach(el => {
                                el.style.backgroundColor = '';
                                el.style.borderColor = '#ddd';
                            });
                            
                            // Select this answer
                            answerDiv.style.backgroundColor = '#e3f2fd';
                            answerDiv.style.borderColor = '#2196F3';
                            selectedAnswerId = answer.answerId;
                        });
                        answersContainer.appendChild(answerDiv);
                    });
                    
                    // Show voting UI
                    hideAllGameSections();
                    voting.classList.remove('hidden');
                });
                
                socket.on('voteSubmitted', (data) => {
                    logEvent('voteSubmitted', data);
                });
                
                socket.on('allVotesSubmitted', (data) => {
                    logEvent('allVotesSubmitted', data);
                    gamePhase.textContent = 'Round Results';
                    
                    // Show round results
                    roundResults.innerHTML = '<h4>Votes:</h4>';
                    data.votes.forEach(vote => {
                        const voteLine = document.createElement('div');
                        voteLine.textContent = `Player ${vote.playerId} voted for answer ${vote.answerId} (from player ${vote.answerOwnerId || 'correct answer'})`;
                        roundResults.appendChild(voteLine);
                    });
                    
                    // Show results UI
                    hideAllGameSections();
                    results.classList.remove('hidden');
                });
                
                socket.on('scoresUpdated', (data) => {
                    logEvent('scoresUpdated', data);
                    
                    // Add scores to results
                    const scoresHeader = document.createElement('h4');
                    scoresHeader.textContent = 'Current Scores:';
                    roundResults.appendChild(scoresHeader);
                    
                    data.playerScores.forEach(playerScore => {
                        const scoreLine = document.createElement('div');
                        scoreLine.textContent = `${playerScore.username}: ${playerScore.score} points`;
                        roundResults.appendChild(scoreLine);
                    });
                });
                
                socket.on('finalResults', (data) => {
                    logEvent('finalResults', data);
                    gamePhase.textContent = 'Game Finished';
                    
                    // Show final results
                    gameResults.innerHTML = '<h4>Final Scores:</h4>';
                    
                    // Sort by score (descending)
                    const sortedScores = [...data.finalScores].sort((a, b) => b.score - a.score);
                    
                    sortedScores.forEach((playerScore, index) => {
                        const scoreLine = document.createElement('div');
                        scoreLine.textContent = `${index + 1}. ${playerScore.username}: ${playerScore.score} points`;
                        if (index === 0) {
                            scoreLine.style.fontWeight = 'bold';
                            scoreLine.style.color = 'green';
                        }
                        gameResults.appendChild(scoreLine);
                    });
                    
                    // Show final results UI
                    hideAllGameSections();
                    finalResults.classList.remove('hidden');
                });
                
                socket.on('gameEnded', (data) => {
                    logEvent('gameEnded', data);
                    gamePhase.textContent = 'Game Ended';
                    alert(data.message);
                });
                
                socket.on('gameAborted', (data) => {
                    logEvent('gameAborted', data);
                    gamePhase.textContent = 'Game Aborted';
                    alert(data.message);
                });
                
            } catch (error) {
                connectionStatus.textContent = `Error: ${error.message}`;
                logEvent('error', { message: error.message });
            }
        });
        
        // Socket disconnection
        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                connectionStatus.textContent = 'Disconnected';
            }
        });
        
        // Game room actions
        joinGameBtn.addEventListener('click', () => {
            if (!socket) {
                alert('Please connect to socket first');
                return;
            }
            
            gameId = parseInt(gameIdInput.value);
            if (!gameId) {
                alert('Please enter a valid game ID');
                return;
            }
            
            socket.emit('joinGameRoom', gameId, (response) => {
                logEvent('joinGameRoom', { gameId }, true);
                if (response && response.success) {
                    alert(`Joined game room ${gameId}`);
                }
            });
        });
        
        leaveGameBtn.addEventListener('click', () => {
            if (!socket || !gameId) {
                alert('Not connected to a game room');
                return;
            }
            
            socket.emit('leaveGameRoom', gameId, (response) => {
                logEvent('leaveGameRoom', { gameId }, true);
                if (response && response.success) {
                    alert(`Left game room ${gameId}`);
                    gameId = null;
                }
            });
        });
        
        startGameBtn.addEventListener('click', () => {
            if (!socket || !gameId) {
                alert('Not connected to a game room');
                return;
            }
            
            socket.emit('startGame', gameId, (response) => {
                logEvent('startGame', { gameId }, true);
                if (response && response.success) {
                    alert(`Started game ${gameId}`);
                }
            });
        });
        
        endGameBtn.addEventListener('click', () => {
            if (!socket || !gameId) {
                alert('Not connected to a game room');
                return;
            }
            
            socket.emit('endGame', gameId, (response) => {
                logEvent('endGame', { gameId }, true);
                if (response && response.success) {
                    alert(`Ended game ${gameId}`);
                }
            });
        });
        
        // Topic selection
        submitTopicBtn.addEventListener('click', () => {
            const topicId = parseInt(topicSelect.value);
            if (!topicId) {
                alert('Please select a topic');
                return;
            }
            
            socket.emit('chooseTopic', { gameId, topicId }, (response) => {
                logEvent('chooseTopic', { gameId, topicId }, true);
                if (response && response.success) {
                    hideAllGameSections();
                }
            });
        });
        
        // Answer submission
        submitAnswerBtn.addEventListener('click', () => {
            const answer = answerInput.value.trim();
            if (!answer) {
                alert('Please enter an answer');
                return;
            }
            
            const createAnswerDto = {
                content: answer,
                roundId: currentRoundId
            };
            
            socket.emit('submitAnswer', { gameId, createAnswerDto }, (response) => {
                logEvent('submitAnswer', { gameId, createAnswerDto }, true);
                if (response && response.success) {
                    answerInput.value = '';
                    answerSubmission.classList.add('hidden');
                }
            });
        });
        
        // Vote submission
        submitVoteBtn.addEventListener('click', () => {
            if (!selectedAnswerId) {
                alert('Please select an answer');
                return;
            }
            
            const createVoteInput = {
                answerId: selectedAnswerId,
                roundNumber: 1 // This should be the current round number, but we're simplifying
            };
            
            socket.emit('submitVote', { gameId, createVoteInput }, (response) => {
                logEvent('submitVote', { gameId, createVoteInput }, true);
                if (response && response.success) {
                    voting.classList.add('hidden');
                    selectedAnswerId = null;
                }
            });
        });
        
        // Clear event log
        clearLogBtn.addEventListener('click', () => {
            eventsLog.innerHTML = '';
        });
        
        // Helper function to hide all game sections
        function hideAllGameSections() {
            topicSelection.classList.add('hidden');
            answerSubmission.classList.add('hidden');
            voting.classList.add('hidden');
            results.classList.add('hidden');
            finalResults.classList.add('hidden');
        }
    </script>
</body>
</html>